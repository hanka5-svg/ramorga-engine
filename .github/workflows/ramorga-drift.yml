name: RAMORGA Architecture Drift Check (Pinned)

on:
  pull_request:
    branches: [ "main" ]

env:
  RAMORGA_ARCH_REPO: hanka5-svg/ramorga-architecture
  RAMORGA_ARCH_TAG: v0.3.0

jobs:
  detect-drift:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout engine
        uses: actions/checkout@v4

      - name: Checkout pinned architecture
        uses: actions/checkout@v4
        with:
          repository: ${{ env.RAMORGA_ARCH_REPO }}
          ref: ${{ env.RAMORGA_ARCH_TAG }}
          path: ramorga-architecture

      - name: Verify architecture tag exists
        run: |
          if [ ! -f ramorga-architecture/README.md ]; then
            echo "❌ Architecture README not found at pinned tag"
            exit 1
          fi

      - name: Extract invariants from pinned architecture
        run: |
          grep '^-\s*`' ramorga-architecture/README.md \
            | sed 's/- `//;s/`//' \
            | sort > /tmp/architecture_invariants.txt

          if [ ! -s /tmp/architecture_invariants.txt ]; then
            echo "❌ No invariants found in pinned architecture"
            exit 1
          fi

      - name: Extract guards from GUARDS.md
        run: |
          grep '^-\s*`' GUARDS.md \
            | sed 's/- `//;s/`//' \
            | sort > /tmp/engine_guards.txt

          if [ ! -s /tmp/engine_guards.txt ]; then
            echo "❌ No guards found in GUARDS.md"
            exit 1
          fi

      - name: Compare pinned architecture invariants vs engine guards
        run: |
          MISSING=$(comm -23 /tmp/architecture_invariants.txt /tmp/engine_guards.txt)
          EXTRA=$(comm -13 /tmp/architecture_invariants.txt /tmp/engine_guards.txt)

          if [ -n "$MISSING" ]; then
            echo "❌ Missing guards for pinned architecture invariants:"
            echo "$MISSING"
            exit 1
          fi

          if [ -n "$EXTRA" ]; then
            echo "❌ Guards without invariant in pinned architecture:"
            echo "$EXTRA"
            exit 1
          fi

          echo "✅ No drift detected against pinned architecture tag"

name: RAMORGA Guard Tag Enforcement

on:
  pull_request:
    branches: [ "main" ]

jobs:
  enforce-ramorga-guards:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load required guards from GUARDS.md
        id: load-guards
        run: |
          if [ ! -f GUARDS.md ]; then
            echo "❌ GUARDS.md not found"
            exit 1
          fi

          grep '^- `' GUARDS.md \
            | sed 's/- `//;s/`//' \
            > /tmp/required_guards.txt

          if [ ! -s /tmp/required_guards.txt ]; then
            echo "❌ No guards found in GUARDS.md"
            exit 1
          fi

          echo "Loaded guards:"
          cat /tmp/required_guards.txt

      - name: Verify presence of all @ramorga-guard tags
        run: |
          while read GUARD; do
            if ! grep -R "@ramorga-guard: $GUARD" . >/dev/null 2>&1; then
              echo "❌ Missing @ramorga-guard tag for invariant: $GUARD"
              exit 1
            fi
          done < /tmp/required_guards.txt

          echo "✅ All RAMORGA guard tags present"

name: RAMORGA Guard Enforcement (Pre-Merge)

on:
  pull_request:
    branches: [ "main" ]

jobs:
  enforce-ramorga-guards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fail if single decision authority exists
        run: |
          if grep -R "final_decision" .; then
            echo "❌ NO_SINGLE_DECISION_POINT violated"
            exit 1
          fi

      - name: Fail if argmax/argmin aggregation is used
        run: |
          if grep -R "argmax\|argmin" .; then
            echo "❌ ASYNC_VOICE_MODEL violated (argmax/argmin found)"
            exit 1
          fi

      - name: Fail if punitive feedback mechanisms exist
        run: |
          if grep -R "penalty\|punish\|negative_reward" .; then
            echo "❌ NO_PUNITIVE_FEEDBACK violated"
            exit 1
          fi

      - name: Fail if auto-rollback or panic on anomaly exists
        run: |
          if grep -R "panic\|rollback\|reset_state" .; then
            echo "❌ GLITCH_IS_INFORMATION violated"
            exit 1
          fi

      - name: Fail if hard thresholds in affective layers exist
        run: |
          if grep -R "if .* > .* then" .; then
            echo "❌ NO_HARD_THRESHOLDS_IN_AFFECTIVE_LAYER violated"
            exit 1
          fi

      - name: Fail if carnival mode is missing
        run: |
          if ! grep -R "carnival_mode" .; then
            echo "❌ CARNIVAL_MODE_REQUIRED violated"
            exit 1
          fi

      - name: Fail if critical actions are not gated by carnival mode
        run: |
          if grep -R "critical_action" . | grep -v "carnival_mode"; then
            echo "❌ NO_CRITICAL_ACTIONS_BEFORE_PLAY violated"
            exit 1
          fi

      - name: Pass if all RAMORGA guards are present
        run: |
          echo "✅ All RAMORGA architectural guards enforced"
